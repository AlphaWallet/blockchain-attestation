<html>
<head>
    <style>
        #log div {
            margin-bottom: 5px;
            background-color: #f5f5f5;
            padding: 5px 10px;
            white-space: normal;
            word-break: break-word;
        }
        .token_link {
            background: #ddd;
            border-radius: 3px;
            opacity: 0.8;
            transition: opacity 0.3s;
            padding: 5px 10px;
            margin: 5px;
            display: inline-block;
            font-family: Helvetica, Arial, sans-serif;
            text-decoration: none;
            text-transform: uppercase;
            color: #000;

        }
        .token_link:hover {
            opacity: 1;
        }
    </style>
</head>
<body>

<a class="token_link" data-ticket="MIGWMA0MATYCBWE3ap3-AgEABEEEKJZVxMEXbkSZZBWnNUTX_5ieu8GUqf0bx_a0tBPF6QYskABaMJBYhDOXsmQt3csk_TfMZ2wdmfRkK7ePCOI2kgNCAOOZKRpcE6tLBuPbfE_SmwPk2wNjbj5vpa6kkD7eqQXvBOCa0WNo8dEHKvipeUGZZEWWjJKxooB44dEYdQO70Vgc"
   data-secret="45845870684" data-id="mah@mah.com" target="_blank">Add test ticket 0</a>

<a class="token_link" data-ticket="MIGXMA4MAjExAgVhN2qd_gIBAARBBCiWVcTBF25EmWQVpzVE1_-YnrvBlKn9G8f2tLQTxekGLJAAWjCQWIQzl7JkLd3LJP03zGdsHZn0ZCu3jwjiNpIDQgBbJBY1Ctlp_czUwB85yF1e5kpZ-lQ_-UZ7jaCYSFoEx028Jit1HIDLCJezKdsNn9c9IO7-HC-_r2ZLaYQ9GGrbHA=="
   data-secret="45845870684" data-id="mah@mah.com" target="_blank">Add test ticket 1</a>

<a class="token_link" data-ticket="MIGTMAoMATYCAgDeAgEABEEEKJZVxMEXbkSZZBWnNUTX_5ieu8GUqf0bx_a0tBPF6QYskABaMJBYhDOXsmQt3csk_TfMZ2wdmfRkK7ePCOI2kgNCAEZYXbNmWXDsAqIc5uf7SirR-dLCMLdEVN5teFrV93VbcKE_DED8c6jtFQ5LH2SRXwPEtXZqWfEh1c2OHTEYqfwb"
   data-secret="45845870684" data-id="mah@mah.com" target="_blank">Add test ticket 2</a>

<a class="token_link" data-ticket="MIGSMAkMATECAQECAQAEQQQollXEwRduRJlkFac1RNf_mJ67wZSp_RvH9rS0E8XpBiyQAFowkFiEM5eyZC3dyyT9N8xnbB2Z9GQrt48I4jaSA0IAOf4d0N9shWfPIgRXZPdBRhlRyIARDT0tJwNWYwy2ILVKnIy-qPzFsgdI6sZHm1OY6UsJKuDlp0A7EMC8vS5YhRs="
   data-secret="45845870684" data-id="mah@mah.com" target="_blank">Add test ticket 3</a>


<div id="log"></div>
    <script type="text/javascript" src="dist/negotiator.js"></script>
<script>
    counter = 1;
    function writeToLog(text){
        let node = document.createElement('div');
        node.innerText = counter + ". " + text;
        log.prepend(node);
        counter++;
    }

    function bnToStringExtension(key, value) {
        return typeof value === 'bigint'
            ? value.toString()
            : value // return everything else unchanged
    }
    (async ()=>{
        // let tokensOrigin = "https://devcontickets.herokuapp.com/outlet/";
        // let tokensOrigin = "https://alladev.com/outlet/";
        let tokensOrigin = "https://alladev.com/attestation20211001/src/main/javascript/negotiator/outlet.html";
        // let attestationOrigin = "http://localhost:5000";

        let buttons = document.querySelectorAll('.token_link');
        if (buttons && buttons.length){
            buttons.forEach(item => {
                item.href = tokensOrigin + '?ticket=' + item.dataset.ticket + "&secret=" + item.dataset.secret  + "&id=" + item.dataset.id;
                item.addEventListener('click', e => {
                    e.preventDefault();
                    n.addTokenThroughIframe(e.target.href);
                    return false;
                })
            })
        }

        let filter = {'devconId': 6 };
        // let filter = { };
        let n = new Negotiator(filter,
            // "https://devcontickets.herokuapp.com/outlet/" hardcoded as default value, we can change it if needed
            {
                tokensOrigin,
                // attestationOrigin
            }
        );
        writeToLog('to start outlet on tokenOrigin site just include negotiator.js and add "<script>let negotiator = new Negotiator();<script>"');
        writeToLog('Open iframe with outlet for : '+ tokensOrigin);
        const tokensOutput = await n.negotiate();
        writeToLog('Recived tokens count: '+  tokensOutput.tokens.length );

        writeToLog( JSON.stringify(tokensOutput, bnToStringExtension) );

        if (tokensOutput.noTokens) {
            writeToLog('No tokens added. Please click buttons at the top of current page' );
        }

        if (tokensOutput.tokens.length) {
            // console.log(JSON.stringify(tokensOutput.tokens[0], bnToStringExtension));
            writeToLog('Found token: ' + JSON.stringify(tokensOutput.tokens[0], bnToStringExtension) );
            let proof;
            try {
                proof = await n.authenticate(tokensOutput.tokens[0]);
                writeToLog('signToken result received. check it in console also. RES=' + JSON.stringify(proof, bnToStringExtension) );
                console.log('proof', proof);
            } catch (e){
                console.log("Authenticate error: " , e.message);
            }

        }

    })();

</script>
</body>
</html>
